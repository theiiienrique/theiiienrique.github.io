name: Run npm audit fix and create PR

on:
  workflow_dispatch: # Allow manual trigger
  schedule:
    - cron: '0 0 * * 1' # Every Monday at midnight

jobs:
  npm-audit-fix:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set Git Author Identity
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install Dependencies
      run: npm ci # Ensures dependencies are cleanly installed

    - name: Display Outdated Packages
      id: outdated-packages
      run: |
        echo "Checking for outdated packages..."
        OUTDATED=$(npm outdated || true)
        echo "$OUTDATED"
        if [ -z "$OUTDATED" ]; then
          echo "No outdated packages found."
          echo "OUTDATED_PACKAGES=No outdated packages found" >> $GITHUB_ENV
        else
          echo "OUTDATED_PACKAGES=$OUTDATED" >> $GITHUB_ENV
        fi

    - name: Run npm audit fix
      id: audit-fix
      run: |
        echo "Running npm audit fix..."
        npm audit fix || echo "No vulnerabilities to fix."

    - name: Check for Changes
      id: check-changes
      run: |
        if git diff --quiet; then
          echo "No changes detected after npm audit fix."
          echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
        else
          echo "Changes detected. Preparing to create PR."
          echo "CHANGES_DETECTED=true" >> $GITHUB_ENV

    - name: Create Pull Request
      if: env.CHANGES_DETECTED == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        branch: chore/npm-audit-fix
        title: "chore: run npm audit fix"
        body: |
          Automated PR to address non-breaking vulnerabilities reported by `npm audit fix`. Changes have been applied automatically.
          
          Outdated dependencies (not updated in this PR):
          ```
          ${{ env.OUTDATED_PACKAGES }}
          ```
        labels: dependencies, automation
